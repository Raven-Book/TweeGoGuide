/* Lang, By BlackStar, Ver.0.2.1 */
(()=>{var e=new class{constructor(e="zh-cn"){this.dbName="Lang",this.lang=e||"zh-cn",this.dbVersion=2,this.db=null}async init(){return new Promise((t,a)=>{var e=indexedDB.open(this.dbName,this.dbVersion);e.onsuccess=e=>{this.db=e.target.result,t(this.db)},e.onerror=e=>{console.error("Database failed to open",e),a(e)},e.onupgradeneeded=e=>{this.db=e.target.result,this.db.objectStoreNames.contains("Lang")?console.log("Object store already exists"):this.db.createObjectStore("Lang",{keyPath:"id"})}})}async set(n,r){return await this.init(),new Promise((e,t)=>{var a=this.db.transaction(["Lang"],"readwrite").objectStore("Lang").put({id:n,...r});a.onsuccess=()=>{e()},a.onerror=e=>{console.error("Failed to set data",e),t(e)}})}async get(n){return await this.init(),new Promise((e,t)=>{let a=this.db.transaction(["Lang"],"readonly").objectStore("Lang").get(n);a.onsuccess=()=>{a.result?e(a.result):(console.log("No data found for id: "+n),e(null))},a.onerror=e=>{console.error("Failed to retrieve data",e),t(e)}})}async delete(n){return await this.init(),new Promise((e,t)=>{var a=this.db.transaction(["Lang"],"readwrite").objectStore("Lang").delete(n);a.onsuccess=()=>{console.log("Data deleted for id: "+n),e()},a.onerror=e=>{console.error("Failed to delete data",e),t(e)}})}};function t({type:e,w:t,name:a=e,eventName:l=a}={}){let d=((e,t)=>{var a={},n=e.source;let r=e.matchStart,s="";var i=[];for(r+=t+2;r<n.length;){var o=n[r];if("|"===o)s&&(i.push(s.trim()),s="");else{if(")"===o){s&&i.push(s.trim()),r+=1;break}s+=o}r++}return a.text=i[0]||"",void 0===i[1]?(a.link=a.text,a.nolink=!0):(a.link=i[1],a.nolink=!1),a.forceInternal=a.link.startsWith("~"),a.args=i.slice(2),a.pos=r,a})(t,e.length),c=Wikifier.helpers.evalPassageId(d.link);t=(Config.debug?new DebugView(t.output,""+a,`(${e}:)`,t.source.slice(t.matchStart,t.nextMatch)):t).output;let g=$("<span></span>").addClass("lang-span");g.appendTo(t),window.LangDB.get(d.text).then(t=>{var a,n,r,s,i,t=t.text;let o={markup:d};if(triggerEvent(":"+l,document,{detail:o}),d.nolink)$("<span></span>").attr("key",d.text).addClass("lang").wiki(t).insertAfter(g);else{let e;(e=d.forceInternal||!Wikifier.isExternalLink(c)?(a=g,n=c,r=t,i=jQuery(document.createElement("a")),null!=n&&(i.attr("data-passage",n),Story.has(n)?(i.addClass("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(n)&&i.addClass("link-visited")):i.addClass("link-broken"),i.ariaClick({one:!0},()=>{"function"==typeof s&&s(),Engine.play(n)})),r&&i.append(document.createTextNode(r)),a&&i.insertAfter(a),i):(r=g,a=c,i=t,i=jQuery(document.createElement("a")).attr("target","_blank").addClass("link-external").text(i).insertAfter(r),null!=a&&i.attr({href:a,tabindex:0}),i)).attr("key",d.text).addClass("lang"),void 0!==o.callback&&e.one("click",e=>{o.callback(e,d)}),g.remove()}}).catch(console.error)}e.init().catch(console.error),Wikifier.Parser.add({name:"lang",profiles:["core"],match:"\\(lang:[^\\)]*\\)",handler(e){t({w:e,type:"lang"})}}),Macro.add("lang",{handler(){if(this.args.length<1)throw new Error("Not enough arguments provided");let t=window.LangDB;t.get("language").then(e=>{(null===e||e.current!==this.args[0])&&(t.set("language",{current:this.args[0]}).catch(console.error),setLang(this.args[0]))})}}),setup.setLang=e=>{let t=window.LangDB;Story.get(e).text.split("\n").forEach(e=>{e=e.split(/(?<!\\):/,2);2===e.length&&t.set(e[0].trim(),{text:e[1].trim()}).catch(console.error)})},window.setLang=window.setLang||setup.setLang,setup.LangDB=e,window.LangDB=window.LangDB||e})();
/* End Lang */