/* Seed, By BlackStar, Ver.0.1.9 */
(()=>{class e{constructor({seed:e=Math.random(),actions:s=[],steps:t=10,history:r=[],rollback:i=10,pushClear:h=[]}={}){if("number"!=typeof e)throw new Error("Expected a number but received: "+e);if(!Array.isArray(s))throw new Error("Expected an array but received: "+s);this.actions=s||[],this.steps="number"==typeof t?t:10,this.history=Array.isArray(r)?r:[],this._seed=e||Math.random(),this._pushClear=h||[],this._rollback="number"==typeof i?i:10}push(...e){let s=[],t=this.actions.length;for(var r of e){var i=this.#push(r);i&&0!==s.length&&(this.#pushHistory({type:"push",seed:i.seed,length:t,number:s.length,cache:Array.from(s)}),t=this.actions.length,s=[]),i&&(this._pushClear.push(this.history.length),this.#pushHistory(i)),s.push(r)}return 0!==s.length&&this.#pushHistory({type:"push",seed:this._seed,length:t,number:s.length,cache:Array.from(s)}),this.actions.length}clear(e=!0,s=!1){var t=new Math.seedrandom(this.seed),r={type:"clear",seed:this._seed,length:this.actions.length,number:this.actions.length,cache:Array.from(this.actions)};return e&&this.#pushHistory(r),this._seed=t(),this.actions.splice(0,this.actions.length),s?r:null}#push(e){let s=null;return this.actions.length>=this.steps&&((s=this.clear(!1,!0)).type="push_clear"),this.actions.push(e),s}#pushHistory(e){if(this.history.length-this._pushClear.length>=this._rollback){this.history.shift();for(let e=0;e<this._pushClear.length;e++)--this._pushClear[e],this._pushClear[e]<=0&&(this._pushClear.splice(e,1),e--)}this.history.push(e)}undo(e){var s=this.actions;if(e<=0)return[];e=e>s.length?s.length:e;var t=this.actions.length,s=s.splice(-e,e);return this.#pushHistory({type:"undo",seed:this._seed,length:t,number:-e,cache:s}),s}rollback(e=1,t=!0){var s,r=this.history,i=r.length;let h=i-1,a=!0;for(let s=h;s>=i-e&&0<=s;s--){var n=r[s];switch(n.type){case"undo":this.actions.push(...n.cache);break;case"push":this.actions.splice(-n.number,n.number);break;case"clear":this.actions.push(...n.cache);break;case"push_clear":this.actions.push(...n.cache),t&&a&&e++;var o=this._pushClear.findIndex(e=>e===s);this._pushClear.splice(o,1)}a&&0<s-1&&"push_clear"===r[s-1].type&&s<=i-e&&(a=!1,e++),h=s}1<=e&&(this._seed=r[h].seed,r.splice(-(s=i<e?i:e),s))}random(e=NaN,s=NaN){var t=new Math.seedrandom(this.seed);return isNaN(e)||isNaN(s)?t():Math.floor(t()*(s-e+1))+e}pushRandom(e){var s=new Math.seedrandom(this.seed)();return e?this.push(`[seed: ${e}]`):this.push(`[random: ${s}]`),s}pushRandomRange(e,s,t){var r=new Math.seedrandom(this.seed)(),s=Math.floor(r*(s-e+1))+e;return t?this.push(`[seed: ${t}]`):this.push(`[random: ${r}]`),s}get seed(){return{seed:this._seed,actions:this.actions}}clone(){return new e({seed:this._seed||Math.random(),actions:this.actions||[],steps:this.steps||10,history:this.history||[],rollback:this._rollback||10,pushClear:this._pushClear||[]})}toJSON(){return Serial.createReviver(String.format("new setup.{0}({seed:{1},actions:{2},steps:{3},history:{4},rollback:{5},pushClear:{6}})","Seed",JSON.stringify(this._seed),JSON.stringify(this.actions),JSON.stringify(this.steps),JSON.stringify(this.history),JSON.stringify(this._rollback),JSON.stringify(this._pushClear)))}}Macro.add("initseed",{handler(){State.variables.seed=State.variables.seed||new e({steps:this.args[0]||10,rollback:this.args[1]||10}),State.variables.ENABLE_SEED_RANDOM=State.variables.ENABLE_SEED_RANDOM||!0}}),setup._raw_seedrandom=e=>{if(void 0===State.variables.seed)throw new Error("Seed must be initialized in StoryInit first");return State.variables.seed.pushRandom(e)},window._raw_seedrandom=window._raw_seedrandom||setup._raw_seedrandom,setup.seedrandom=(e,s,t)=>{if(void 0===State.variables.seed)throw new Error("Seed must be initialized in StoryInit first");return State.variables.seed.pushRandomRange(e,s,t)},window.seedrandom=window.seedrandom||setup.seedrandom,setup.Seed=e,window.Seed=window.Seed||e})();
/* End Seed */