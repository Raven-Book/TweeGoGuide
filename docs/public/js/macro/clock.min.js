/* Clock Macro, By BlackStar, Ver.0.2.5.alpha.29 */
(()=>{setup.TimeUnit=Object.freeze({MILLISECOND:"millisecond",SECOND:"second",MINUTE:"minute",HOUR:"hour",DAY:"day",MONTH:"month",YEAR:"year"}),window.TimeUnit=window.TimeUnit||setup.TimeUnit,setup.GlobalTriggers=new Map([]);class GTrigger{static add(t,e,i,r=!1){var a=setup.GlobalTriggers,e=Trigger.replaceVariables(e.toString()),i=Trigger.replaceVariables(i.toString());a.set(t,{condition:e,callback:i,single:r,sugar:!1})}static addSugar(t,e,i,r=!1){var a=setup.GlobalTriggers,e=Trigger.replaceVariables(e.toString());a.set(t,{condition:e,callback:i.toString(),single:r,sugar:!0})}static delete(t){setup.GlobalTriggers.delete(t)}}class Trigger{static replaceVariables=t=>{let i=[],r=[],a=[];return t.replace(/(\/\*[\s\S]*?\*\/|\/\/.*)/g,t=>(r.push(t),`@@COMMENT_PLACEHOLDER_${r.length}@@`)).replace(/(`(?:\\[\s\S]|[^\\`])*?`)/g,t=>(a.push(t),`@@TEMPLATE_PLACEHOLDER_${a.length}@@`)).replace(/(["'])(?:\\.|[^\\])*?\1/g,t=>(i.push(t),`@@STRING_PLACEHOLDER_${i.length}@@`)).replace(/(?<=[\s\n\t{}()\[\],;<>!=+\-*/%:|&]|^)\b(year|month|day|hour|minute|lastUpdate|weekday|isInRange)\b/g,t=>"this."+t).replace(/(?<=[\s\n\t{}()\[\],;<>!=+\-*/%:|&]|^)\$(\w+)\b/g,(t,e)=>"State.variables."+e).replace(/(?<=[\s\n\t{}()\[\],;<>!=+\-*/%:|&]|^)_(\w+)\b/g,(t,e)=>"State.temporary."+e).replace(/@@STRING_PLACEHOLDER_(\d+)@@/g,(t,e)=>i[e-1]).replace(/@@COMMENT_PLACEHOLDER_(\d+)@@/g,(t,e)=>r[e-1]).replace(/@@TEMPLATE_PLACEHOLDER_(\d+)@@/g,(t,e)=>a[e-1])};static add(t,e,i,r=!1){var a=State.variables.Triggers,e=Trigger.replaceVariables(e.toString()),i=Trigger.replaceVariables(i.toString());a.set(t,{condition:e,callback:i,single:r,sugar:!1})}static addSugar(t,e,i,r=!1){var a=State.variables.Triggers,e=Trigger.replaceVariables(e.toString());a.set(t,{condition:e,callback:i.toString(),single:r,sugar:!0})}static delete(t){State.variables.Triggers.delete(t)}}class CTrigger{static parse(t){t=t.trim().split(/\s+/);if(6!==t.length)throw new Error("Invalid cron expression format. Expected: minute hour day month weekday year");return{minute:t[0],hour:t[1],day:t[2],month:t[3],weekday:t[4],year:t[5]}}static matches(t,e,i){for(var r,a,s=(t,e,i)=>{var r,a,s;return"*"===t||(t.includes("/")?([s,r]=t.split("/"),r=parseInt(r),"*"===s?e%r==0:!!s.includes("-")&&([s,a]=s.split("-").map(Number),s<=e)&&e<=a&&(e-s)%r==0):t.includes("-")?([a,s]=t.split("-").map(Number),a<=e&&e<=s):t.split(",").map(Number).includes(e))},n=new Date(e.year,e.month-1,e.day,e.hour,e.minute),e=new Date(i.year,i.month-1,i.day,i.hour,i.minute),o=new Date(e),d=(t.minute.includes("/")?([r,i]=t.minute.split("/"),e=parseInt(i),i=o.getMinutes(),(a=Math.ceil(i/e)*e)===i?o.setMinutes(a+e):o.setMinutes(a)):"0"===t.minute?0!==o.getMinutes()?(o.setMinutes(60),o.setMinutes(0)):o.setHours(o.getHours()+1):o.setMinutes(o.getMinutes()+1),[]);o<=n;)s(t.minute,o.getMinutes())&&s(t.hour,o.getHours())&&s(t.day,o.getDate())&&s(t.month,o.getMonth()+1)&&s(t.weekday,o.getDay())&&s(t.year,o.getFullYear())&&d.push(new Date(o)),o.setMinutes(o.getMinutes()+1);return{timePoints:d,expired:0===d.length&&((t,e)=>{if("*"!==t.year){t=(t.year.includes("-")?t.year.split("-"):t.year.split(",")).map(Number),t=Math.max(...t);if(e.getFullYear()>t)return!0}return!1})(t,n)}}static add(t,e,i,r=!1){var a=State.variables.Triggers,e=CTrigger.parse(e);a.set(t,{type:"cron",cronParts:e,callback:i.toString(),single:r,sugar:!1})}static addSugar(t,e,i,r=!1){var a=State.variables.Triggers,e=CTrigger.parse(e);a.set(t,{type:"cron",cronParts:e,callback:i.toString(),single:r,sugar:!0})}}class Clock{static varName="$clock";static weekdays=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"];static incrementTime=6e4;static opts={start:!0,updateInterval:Clock.updateInterval,isTimeFlowEnabled:Clock.isTimeFlowEnabled};#intervalId=null;#start=!0;constructor(t=2024,e=1,i=1,r=1,a=0,s=0,n=0,o=clone(Clock.opts)){this.year=t??2024,this.month=e??1,this.day=i??1,this.hour=r??1,this.minute=a??0,this.second=s??0,this.millisecond=n??0,this._opts=o,this.#start=o.start,this.lastUpdate={year:t,month:e,day:i,hour:r,minute:a,second:s,millisecond:n},this.#start&&this.start()}changeInterval(t){var e=this.#start;this.stop(),this._opts.updateInterval=Number(t)||Clock.opts.updateInterval,e&&this.start()}start(){this._opts.isTimeFlowEnabled&&null==this.#intervalId&&(this.#start=!0,this.#intervalId=setInterval(()=>{this.addMilliseconds(Clock.incrementTime)},this._opts.updateInterval))}stop(){clearInterval(this.#intervalId),this.#intervalId=null,this.#start=!1}getDaysInMonth(t=this.year,e=this.month){return[31,Clock.isLeapYear(t)?29:28,31,30,31,30,31,31,30,31,30,31][e-1]}getFormattedTime(){return`${this.year}-${Clock.formatTwoDigits(this.month)}-${Clock.formatTwoDigits(this.day)} ${Clock.formatTwoDigits(this.hour)}:`+Clock.formatTwoDigits(this.minute)}carryOverTime(){for(1e3<=this.millisecond&&(this.second+=Math.floor(this.millisecond/1e3),this.millisecond%=1e3),60<=this.second&&(this.minute+=Math.floor(this.second/60),this.second%=60),60<=this.minute&&(this.hour+=Math.floor(this.minute/60),this.minute%=60),24<=this.hour&&(this.day+=Math.floor(this.hour/24),this.hour%=24);this.day>this.getDaysInMonth();)this.day-=this.getDaysInMonth(),this.month++,12<this.month&&(this.month=1,this.year++)}updateLastTime(){this.lastUpdate={year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second,millisecond:this.millisecond}}next(t=1,e=TimeUnit.DAY){var i={year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second,millisecond:this.millisecond};switch(e){case TimeUnit.MILLISECOND:this.millisecond+=t;break;case TimeUnit.SECOND:this.second+=t;break;case TimeUnit.MINUTE:this.minute+=t;break;case TimeUnit.HOUR:this.hour+=t;break;case TimeUnit.DAY:this.day+=t;break;case TimeUnit.MONTH:this.month+=t;break;case TimeUnit.YEAR:this.year+=t;break;default:throw new Error("Invalid time unit")}this.carryOverTime();var r,e=new Date(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);for(r in i)i.hasOwnProperty(r)&&(this[r]=i[r]);return e}get millisecondDiff(){var t=new Date(this.lastUpdate.year,this.lastUpdate.month-1,this.lastUpdate.day,this.lastUpdate.hour,this.lastUpdate.minute,this.lastUpdate.second,this.lastUpdate.millisecond);return new Date(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond)-t}get secondDiff(){var t=new Date(this.lastUpdate.year,this.lastUpdate.month-1,this.lastUpdate.day,this.lastUpdate.hour,this.lastUpdate.minute,this.lastUpdate.second);return(new Date(this.year,this.month-1,this.day,this.hour,this.minute,this.second)-t)/1e3}get minutesDiff(){var t=new Date(this.lastUpdate.year,this.lastUpdate.month-1,this.lastUpdate.day,this.lastUpdate.hour,this.lastUpdate.minute);return(new Date(this.year,this.month-1,this.day,this.hour,this.minute)-t)/6e4}get daysDiff(){var t=new Date(this.year,this.month-1,this.day),e=new Date(this.lastUpdate.year,this.lastUpdate.month-1,this.lastUpdate.day),t=Math.abs(t-e);return Math.ceil(t/864e5)}parseTime(t){var[t,e]=t.split(":").map(Number),i=new Date;return i.setHours(t,e,0,0),i}parseDateTime(t,e){let[i,r,a]=[this.year,this.month,this.day];t&&([i,r,a]=t.split("-").map(Number));var[t,e]=e.split(":").map(Number);return new Date(i,r-1,a,t,e)}parseTimeRange(t){var e,i,r,a,t=t.match(/(\d{4}-\d{1,2}-\d{1,2})?\s*(\d{2}:\d{2})?\s*to\s*(\d{4}-\d{1,2}-\d{1,2})?\s*(\d{2}:\d{2})?/);if(t)return[e,t,a,i,r]=t,a=this.parseDateTime(t,a||"00:00"),t=this.parseDateTime(i||t,r||"23:59"),null==i&&a.getTime()>t.getTime()&&t.setDate(t.getDate()+1),{start:a,end:t};throw new Error("Invalid time range format")}isInRange(t){var{start:t,end:e}=this.parseTimeRange(t),i=new Date(this.year,this.month-1,this.day,this.hour,this.minute);return t<=i&&i<=e}addMilliseconds(t){this.millisecond+=t,this.updateState()}addSeconds(t){this.second+=t,this.updateState()}addMinutes(t){this.minute+=t,this.updateState()}updateState(){this.carryOverTime(),this.checkTriggers(),this.updateLastTime()}addHours(t){this.addMinutes(60*t)}addDays(t){this.addMinutes(24*t*60)}addMonths(t){let e=0,i=this.year,r=this.month;repeat(t,t=>{12<=r?(r=1,i+=1):0!==t&&(r+=1),e+=this.getDaysInMonth(i,r)}),this.addDays(e)}addYears(t){this.addDays(t*(Clock.isLeapYear(this.year)?366:365))}runTriggers({Triggers,msd,sd,td,dd}){for(var[key,trigger]of Triggers){let isExec=eval(trigger.condition);if(isExec){try{trigger.sugar?$.wiki(trigger.callback):eval(`(${trigger.callback})`)()}catch(e){alert(`An error occurred in the trigger with ID \`${key}\`. The specific error is: `+e.message)}trigger.single&&Triggers.delete(key)}}}checkTriggers(){let Triggers=State.variables.Triggers,msd=this.millisecondDiff,sd=this.secondDiff,td=this.minutesDiff,dd=this.daysDiff;for(var[key,trigger]of Triggers)if("cron"===trigger.type){let{timePoints,expired}=CTrigger.matches(trigger.cronParts,this,this.lastUpdate);if(expired)Triggers.delete(key);else{for(var point of timePoints)try{trigger.sugar?$.wiki(trigger.callback):eval(`(${trigger.callback})`)()}catch(e){alert(`An error occurred in the cron trigger with ID \`${key}\`. The specific error is: `+e.message)}trigger.single&&0<timePoints.length&&Triggers.delete(key)}}else{let isExec=eval(trigger.condition);if(isExec){try{trigger.sugar?$.wiki(trigger.callback):eval(`(${trigger.callback})`)()}catch(e){alert(`An error occurred in the trigger with ID \`${key}\`. The specific error is: `+e.message)}trigger.single&&Triggers.delete(key)}}this.runTriggers({Triggers:setup.GlobalTriggers,msd:msd,sd:sd,td:td,dd:dd}),triggerEvent(":time_updated",document,{detail:{msd:msd,sd:sd,td:td,dd:dd,clock:this}})}displayMonth(){return Clock.formatTwoDigits(this.month)}displayDay(){return Clock.formatTwoDigits(this.day)}displayHour(){return Clock.formatTwoDigits(this.hour)}displayMinute(){return Clock.formatTwoDigits(this.minute)}displaySecond(){return Clock.formatTwoDigits(this.second)}get weekday(){return new Date(this.year,this.month-1,this.day).getDay()}get weekdayChs(){return Clock.weekdays[this.weekday]}get date(){return new Date(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond)}static isLeapYear(t){return t%4==0&&t%100!=0||t%400==0}static formatTwoDigits(t){return t.toString().padStart(2,"0")}clone(){return new Clock(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond,this._opts)}toJSON(){return Serial.createReviver(String.format("new {0}({1},{2},{3},{4},{5},{6},{7},{8})","Clock",JSON.stringify(this.year),JSON.stringify(this.month),JSON.stringify(this.day),JSON.stringify(this.hour),JSON.stringify(this.minute),JSON.stringify(this.second),JSON.stringify(this.millisecond),JSON.stringify(this._opts)))}}Macro.add("newclock",{handler(){let e=this.args;var t=t=>{t=parseInt(e[t]);return isNaN(t)?void 0:t};State.getVar(Clock.varName)||State.setVar("$clock",new Clock(t(0),t(1),t(2),t(3),t(4))),State.variables.Triggers=State.variables.Triggers||new Map}});let createAddTimeMacro=(t="milliseconds",e=1)=>{t=t.toLowerCase();let i=t.replace(/^./,t=>t.toUpperCase());Macro.add("add"+t,{handler(){var t;return this.args.length<e?this.error(`Not enough arguments provided. At least ${e} argument${1<e?"s":""} are required.`):(t=Number(this.args[0]),isNaN(t)?this.error("Expected a number but received: "+typeof this.args[0]):void State.getVar(Clock.varName)["add"+i](t))}})};createAddTimeMacro("milliseconds"),createAddTimeMacro("seconds"),createAddTimeMacro("minutes"),createAddTimeMacro("hours"),createAddTimeMacro("days"),createAddTimeMacro("months"),createAddTimeMacro("years"),Macro.add("ftime",{handler(){var t=State.getVar(Clock.varName);$(this.output).wiki(t.getFormattedTime())}}),Macro.add("fhour",{handler(){var t=State.getVar(Clock.varName);$(this.output).wiki(t.displayHour())}}),Macro.add("fminute",{handler(){var t=State.getVar(Clock.varName);$(this.output).wiki(t.displayMinute())}}),Macro.add("fsecond",{handler(){var t=State.getVar(Clock.varName);$(this.output).wiki(t.displaySecond())}}),Macro.add("fday",{handler(){var t=State.getVar(Clock.varName);$(this.output).wiki(t.displayDay())}}),Macro.add("fmonth",{handler(){var t=State.getVar(Clock.varName);$(this.output).wiki(t.displayMonth())}}),Macro.add("fyear",{handler(){var t=State.getVar(Clock.varName);$(this.output).wiki(t.year)}}),Macro.add("weekday",{handler(){var t=State.getVar(Clock.varName);$(this.output).wiki(t.weekdayChs)}}),setup.redo=(t="")=>{t=String(t).trim().splitOrEmpty(/\s+/),triggerEvent(":redo",document,{detail:{tags:t}})},window.redo=window.redo||setup.redo,setup.Trigger=Trigger,window.Trigger=window.Trigger||Trigger,setup.GTrigger=GTrigger,window.GTrigger=window.GTrigger||GTrigger,setup.CTrigger=CTrigger,window.CTrigger=window.CTrigger||CTrigger,setup.Clock=Clock,window.Clock=window.Clock||Clock})();
/* End Clock Macro */ 