/* Type-wp, Modified from SugarCube, Ver.0.1.2 */
Macro.add("type-wp",{isAsync:true,tags:null,typeId:0,handler(){if(this.args.length===0){return this.error("no speed specified")}const speed=cssTimeToMS(this.args[0]);if(speed<0){return this.error(`speed time value must be non-negative (received: ${this.args[0]})`)}let cursor;let elClass="";let elId="";let elTag="div";let skipKey=Config.macros.typeSkipKey;let start=400;let pause=speed;let symbols=RegExp(/[]/);const options=this.args.slice(1);while(options.length>0){const option=options.shift();switch(option){case"class":{if(options.length===0){return this.error("class option missing required class name(s)")}elClass=options.shift();if(elClass===""){throw new Error('class option class name(s) must be non-empty (received: "")')}break}case"element":{if(options.length===0){return this.error("element option missing required element tag name")}elTag=options.shift();if(elTag===""){throw new Error('element option tag name must be non-empty (received: "")')}break}case"id":{if(options.length===0){return this.error("id option missing required ID")}elId=options.shift();if(elId===""){throw new Error('id option ID must be non-empty (received: "")')}break}case"keep":cursor="keep";break;case"none":cursor="none";break;case"skipkey":{if(options.length===0){return this.error("skipkey option missing required key value")}skipKey=options.shift();if(skipKey===""){throw new Error('skipkey option key value must be non-empty (received: "")')}break}case"start":{if(options.length===0){return this.error("start option missing required time value")}const value=options.shift();start=cssTimeToMS(value);if(start<0){throw new Error(`start option time value must be non-negative (received: ${value})`)}break}case"pause":{if(options.length===0){return this.error("pause option missing required time value")}const value=options.shift();pause=cssTimeToMS(value);if(start<0){throw new Error(`pause option time value must be non-negative (received: ${value})`)}break}case"symbols":{if(options.length===0){return this.error("symbols option missing required time value")}const value=options.shift();const escapedStr=value.replace(/([.*+?^${}()|[\]\\/])/g,"\\$1");symbols=RegExp(`[${escapedStr}]`);if(start<0){throw new Error(`symbols option time value must be non-negative (received: ${value})`)}break}default:return this.error(`unknown option: ${option}`)}}const contents=this.payload[0].contents;if(contents.trim()===""){return}if(Config.debug){this.debugView.modes({block:true})}const className=`macro-${this.name}`;const namespace=`.${className}`;const $target=jQuery(document.createElement(elTag)).addClass(`${className} ${className}-target`).appendTo(this.output);if(!TempState.macroTypeQueue){TempState.macroTypeQueue=[];$(document).off(namespace).one(`:passageinit${namespace}`,(()=>$(document).off(namespace)))}const startTyping=TempState.macroTypeQueue.length===0;const selfId=++this.self.typeId;const allowCleanup=this.self.allowCleanup;TempState.macroTypeQueue.push({id:selfId,handler:this.shadowHandler((()=>{const $wrapper=jQuery(document.createElement(elTag)).addClass(className);if(elId){$wrapper.attr("id",elId)}if(elClass){$wrapper.addClass(elClass)}new Wikifier($wrapper,contents,allowCleanup(elTag)?undefined:{cleanup:false});const passage=State.passage;const turn=State.turns;if(speed===0||!Config.macros.typeVisitedPassages&&State.passages.slice(0,-1).some((title=>title===passage))||$wrapper.find(".error").length>0){$target.replaceWith($wrapper);TempState.macroTypeQueue.shift();if(TempState.macroTypeQueue.length>0){TempState.macroTypeQueue.first().handler()}return}const typer=new NodeTyper({targetNode:$wrapper.get(0),classNames:cursor==="none"?null:`${className}-cursor`});$target.replaceWith($wrapper);const typingCompleteId=":typingcomplete";const typingStartId=":typingstart";const typingStopId=":typingstop";const keydownAndNS=`keydown${namespace}`;const typingStopAndNS=`${typingStopId}${namespace}`;$(document).off(keydownAndNS).on(keydownAndNS,(ev=>{if(scrubEventKey(ev.key)===skipKey&&(ev.target===document.body||ev.target===document.documentElement)){ev.preventDefault();$(document).off(keydownAndNS);typer.finish()}})).one(typingStopAndNS,(()=>{if(TempState.macroTypeQueue){if(TempState.macroTypeQueue.length===0){triggerEvent(typingCompleteId)}else{TempState.macroTypeQueue.first().handler()}}}));$("body, .type-click-skip").on("click",(ev=>{if($(ev.target).closest("#ui-bar, .type-exclude, button, input, textarea, a").length>0){return}ev.preventDefault();typer.finish()}));const typeNode=function typeNode(){const typeNodeMember=function typeNodeMember(typeIntervalId){if(State.passage!==passage||State.turns!==turn||!typer.type()){if(typeIntervalId){clearInterval(typeIntervalId)}if(TempState.macroTypeQueue&&TempState.macroTypeQueue.length>0&&TempState.macroTypeQueue.first().id===selfId){TempState.macroTypeQueue.shift()}triggerEvent(typingStopId,$wrapper);$wrapper.addClass(`${className}-done`);if(cursor==="keep"){$wrapper.addClass(`${className}-cursor`)}}const lastChar=$wrapper.text().slice(-1);let delay=speed;if(symbols.test(lastChar)){delay=pause}setTimeout(typeNodeMember,delay)};triggerEvent(typingStartId,$wrapper);typeNodeMember()};if(start){setTimeout(typeNode,start)}else{typeNode()}}))});if(startTyping){if(Engine.isPlaying()){$(document).one(`:passageend${namespace}`,(()=>TempState.macroTypeQueue.first().handler()))}else{TempState.macroTypeQueue.first().handler()}}},allowCleanup(tagName){switch(tagName.toUpperCase()){case"ARTICLE":case"DIV":case"FOOTER":case"FORM":case"HEADER":case"MAIN":case"SECTION":return true}return false}});
/* End Type-wp */