/* SugarEvents, By BlackStar, Ver.0.1.0 */
(()=>{let o=new Map,l=new Set,i=new class{constructor(){this.placeholders={strings:new Map,comments:new Map,templates:new Map},this.patterns={comments:/(\/\*[\s\S]*?\*\/|\/\/.*)/g,templates:/(`(?:\\[\s\S]|[^\\`])*?`)/g,strings:/(["'])(?:\\.|[^\\])*?\1/g,replacements:[{pattern:/(?<=[\s\n\t{}()\[\],;<>!=+\-*/%:|&]|^)\$(\w+)\b/g,replace:(e,t)=>"SugarCube.State.variables."+t},{pattern:/(?<=[\s\n\t{}()\[\],;<>!=+\-*/%:|&]|^)_(\w+)\b/g,replace:(e,t)=>"SugarCube.State.temporary."+t},{pattern:/(?<=[\s\n\t{}()\[\],;<>!=+\-*/%:|&]|^)setup\b/g,replace:()=>"SugarCube.setup"}]}}_createPlaceholder(e,t){var r=this.placeholders[e],s=r.size+1,e=`@@${e.toUpperCase()}_${s}@@`;return r.set(e,t),e}_replace(e,t,r){return e.replace(t,e=>this._createPlaceholder(r,e))}_restore(e,t){let r=this.placeholders[t];return e.replace(new RegExp(`@@${t.toUpperCase()}_\\d+@@`,"g"),e=>r.get(e))}clear(){Object.values(this.placeholders).forEach(e=>e.clear())}replace(r){return this.patterns.replacements.forEach(({pattern:e,replace:t})=>{r=r.replace(e,t)}),r}process(t,e=0){if("true"===t||"false"===t)return t;try{this.clear();let r=t;return r=this._replace(r,this.patterns.comments,"comments"),r=this._replace(r,this.patterns.templates,"templates"),r=this._replace(r,this.patterns.strings,"strings"),this.patterns.replacements.forEach(({pattern:e,replace:t})=>{r=r.replace(e,t)}),r=this._restore(r,"strings"),r=this._restore(r,"templates"),r=this._restore(r,"comments")}catch(e){return console.error("处理代码时发生错误:",e),t}}};function a(e){return Array.isArray(e)?e:"string"==typeof e?[e]:[]}let n={ignoreChildCondition:!1,ignoreChildOutput:!0,alwaysActive:!0,isChild:!1,content:"",description:"",random:{},sequential:[],prob:1,count:-1};class h{constructor(e,t,r=clone(n),s){this.id=e,this.name=r.name||e,this.passage=t||"",Object.assign(this,Object.assign({},n,r)),this.trigger=a(r.trigger),this.condition=new Function("ev","return "+(r.condition||"true")),this.tags=a(s)}isBlock(e){var e=!(0===this.trigger.length||this.trigger.includes(e)),t=!rollChance(this.prob);let r;try{r=!this.condition(this)}catch(e){r=!0,console.warn(e)}return e||t||r}execute(e,t=[],r=0){if(!(3<r||this.isBlock(e))){var s=h.counter.get(this.id)||0;if(!(-1!==this.count&&s>=this.count)){n=h.counter,i=this.id,n.set(i,(n.get(i)||0)+1),s=n.get(i),this.passage&&0!==this.passage.length&&Story.has(this.passage)&&((n=$(document.createDocumentFragment())).wikiPassage(this.passage),t.push(n)),this.content&&0!==this.content.length&&((i=$(document.createDocumentFragment())).wiki(this.content),t.push(i));var a,n=[],i=Object.entries(this.random);0<i.length&&(i=i.reduce((e,[t,r])=>(h.isUsageAvailable(t)&&(e[t]=r),e),{}),0<Object.keys(i).length)&&n.push(drawOptionByWeight(i));for(a of this.sequential.concat(n)){var c=o.get(a);c&&c.execute(e,this.ignoreChildOutput?t:[],r+1)}return 0<=this.count&&s>=this.count&&((this.alwaysActive?l:h.active).delete(this.id),this.isChild||h.counter.delete(this.id)),t}}}static child(e,t,r,s,a="process",n=!0){return r.alwaysActive=r.alwaysActive??!1,r.isChild=!0,h.create(e,t,r,s,a,n)}static create(e,t,r,s,a="process",n=!0){n&&"string"==typeof r.condition&&0<r.condition.length&&(r.condition=i[a](r.condition));n=new h(e,t,r,s);return o.set(e,n),n.alwaysActive&&l.add(e),n}static isUsageAvailable(e){var t=o.get(e);return!!t&&(h.counter.get(e)||0)<t.count}static get data(){return o}static get counter(){var e=State.variables;return e.EventCounter=e.EventCounter||new Map,e.EventCounter}static get active(){var e=State.variables;return e.ActiveEvents=e.ActiveEvents||new Set,e.ActiveEvents}}Macro.add("output",{handler(){$("<div>").attr("id","sugarevent-container").appendTo(this.output)}});let c=[];$(document).on(":passagestart",e=>{var t,r=h.active;for(t of new Set([...l,...r])){var s=o.get(t);s&&s.execute(e.passage.name,c)}}),$(document).on(":passageend",e=>{var t=$("#sugarevent-container");if(t){for(var r of c)r.appendTo(t);c.length=0}}),Macro.add(["sugarchild","sugarevent"],{tags:["condition","count","opts","description","child","tags","trigger"],handler(){if(this.args.length<1)return this.error("事件名不能为空");var e,t=this.args[0],[r,s]=((e,t)=>{let r=1,s="";var a=typeof e,n=typeof t;if(void 0!==e||void 0!==t)if("string"==a&&"number"==n)s=e,r=t;else if("number"==n&&void 0===e)r=t;else{if("string"==a&&"string"==n)throw new Error("概率必须为数字");r=e??1,s=t??""}return[r,s]})(this.args[1],this.args[2]),a={};let n;a.prob=r,a.content=this.payload[0].contents.trim()||null;for(e of this.payload.slice(1))switch(e.name){case"description":a.description=e.contents.trim();break;case"count":a.count=e.args[0]??-1;break;case"condition":a.condition=e.arguments;break;case"opts":"object"==typeof e.args[0]&&Object.assign(a,e.args[0]);break;case"trigger":a.trigger=e.args;break;case"tags":n=e.args;break;case"child":var i=(r=>{if(!Array.isArray(r)||0===r.length)return r;if(1===r.length)return r;if("number"!=typeof r[1])return r;var s={};for(let t=0;t<r.length;t+=2){var a=r[t];let e=r[t+1];void 0===e&&(e=r[1]),s[a]=e}return s})(e.args);Array.isArray(i)?a.sequential=i:a.random=i}r="sugarevent"===this.name?"create":"child";console.log(h[r](t,s,a,n,"replace"))}}),window.SugarEvent=window.SugarEvent||h,setup.SugarEvent=h})();
/* End SugarEvents */